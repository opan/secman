<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecMan - Kubernetes Secret Manager</title>
    
    <!-- Franken UI CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/franken-ui@1.1.0/dist/css/core.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/franken-ui@1.1.0/dist/css/theme.min.css" />
    
    <!-- Custom styles -->
    <style>
        :root {
            --primary: 222.2 84% 4.9%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 84% 4.9%;
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 84% 4.9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --radius: 0.5rem;
        }

        .dark {
            --primary: 210 40% 98%;
            --primary-foreground: 222.2 84% 4.9%;
            --secondary: 222.2 84% 4.9%;
            --secondary-foreground: 210 40% 98%;
            --muted: 222.2 84% 4.9%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 222.2 84% 4.9%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 212.7 26.8% 83.9%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        .agent-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .agent-status-online {
            background-color: #22c55e;
        }

        .agent-status-offline {
            background-color: #ef4444;
        }

        .sidebar {
            border-right: 1px solid hsl(var(--border));
            background-color: hsl(var(--muted) / 0.4);
        }

        .nav-item {
            border-radius: var(--radius);
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background-color: hsl(var(--accent));
        }

        .nav-item.active {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .card {
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            background-color: hsl(var(--card));
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        .btn {
            border-radius: var(--radius);
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            border: none;
        }

        .btn-primary {
            background-color: #1f2937;
            color: white;
            border: 1px solid #1f2937;
        }

        .btn-primary:hover {
            background-color: #111827;
        }

        .btn-secondary {
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        .btn-destructive {
            background-color: #ef4444;
            color: white;
            border: 1px solid #ef4444;
        }

        .btn-destructive:hover {
            background-color: #dc2626;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #d1d5db;
            color: #374151;
        }

        .btn-outline:hover {
            background-color: #f9fafb;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .input {
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .input:focus {
            outline: none;
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
        }

        .select {
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .table {
            border-collapse: collapse;
            width: 100%;
        }

        .table th,
        .table td {
            border-bottom: 1px solid hsl(var(--border));
            padding: 0.75rem;
            text-align: left;
        }

        .table th {
            font-weight: 600;
            color: hsl(var(--muted-foreground));
        }

        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: calc(var(--radius) - 2px);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge-success {
            background-color: #22c55e;
            color: white;
        }

        .badge-destructive {
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgb(0 0 0 / 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: white;
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            max-width: 36rem;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .alert {
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .alert-info {
            background-color: hsl(214 100% 97%);
            border-color: hsl(214 100% 85%);
            color: hsl(214 100% 31%);
        }

        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .p-6 {
            padding: 1.5rem;
        }

        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-lg {
            font-size: 1.125rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .text-2xl {
            font-size: 1.5rem;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-bold {
            font-weight: 700;
        }

        .text-muted-foreground {
            color: hsl(var(--muted-foreground));
        }

        .grid {
            display: grid;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .col-span-2 {
            grid-column: span 2 / span 2;
        }

        @media (min-width: 768px) {
            .md\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }

        .space-y-4 > * + * {
            margin-top: 1rem;
        }

        .w-full {
            width: 100%;
        }

        .h-full {
            height: 100%;
        }

        .min-h-screen {
            min-height: 100vh;
        }

        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }

        .space-y-4 > * + * {
            margin-top: 1rem;
        }

        .space-y-6 > * + * {
            margin-top: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .modal-header {
            padding: 1.5rem 1.5rem 0 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .modal-body {
            padding: 0 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            margin-top: 1.5rem;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Navigation -->
    <nav class="uk-navbar-container uk-navbar-transparent" uk-navbar>
        <div class="uk-navbar-left">
            <a class="uk-navbar-item uk-logo font-bold text-xl" href="#">SecMan</a>
        </div>
        <div class="uk-navbar-center">
            <ul class="uk-navbar-nav">
                <li class="nav-item active"><a href="#" id="nav-dashboard">Dashboard</a></li>
                <li class="nav-item"><a href="#" id="nav-agents">Agents</a></li>
                <li class="nav-item"><a href="#" id="nav-secrets">Secrets</a></li>
            </ul>
        </div>
    </nav>

    <div class="uk-container-expand">
        <div uk-grid class="uk-grid-collapse">
            <!-- Sidebar -->
            <div class="uk-width-1-5@m sidebar">
                <div class="p-6">
                    <h3 class="font-semibold text-sm text-muted-foreground mb-4">Connected Agents</h3>
                    <div class="space-y-2" id="agents-list">
                        <div class="flex items-center gap-2 py-2 px-4 text-sm">
                            <span class="agent-status agent-status-offline"></span>
                            No agents connected
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="uk-width-4-5@m">
                <div class="p-6">
                    <!-- Dashboard View -->
                    <div id="dashboard-view">
                        <div class="flex items-center justify-between mb-6">
                            <h1 class="text-2xl font-bold">Dashboard</h1>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="card p-6">
                                <h3 class="font-semibold text-sm text-muted-foreground mb-2">Connected Agents</h3>
                                <p class="text-2xl font-bold" id="agent-count">0</p>
                            </div>
                            <div class="card p-6">
                                <h3 class="font-semibold text-sm text-muted-foreground mb-2">Total Secrets</h3>
                                <p class="text-2xl font-bold" id="secret-count">-</p>
                            </div>
                            <div class="card p-6">
                                <h3 class="font-semibold text-sm text-muted-foreground mb-2">Server Status</h3>
                                <span class="badge badge-success" id="server-status">Online</span>
                            </div>
                        </div>
                    </div>

                    <!-- Agents View -->
                    <div id="agents-view" class="hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h1 class="text-2xl font-bold">Agents</h1>
                        </div>
                        
                        <div class="card">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Name</th>
                                        <th>ID</th>
                                        <th>Kubernetes Version</th>
                                        <th>Nodes</th>
                                        <th>Last Seen</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agents-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Secrets View -->
                    <div id="secrets-view" class="hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h1 class="text-2xl font-bold">Secrets</h1>
                            <button class="btn btn-primary" id="btn-create-secret">Create Secret</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="text-sm font-semibold mb-2 block">Agent</label>
                                <select class="select w-full" id="agent-selector">
                                    <option selected>Select Agent</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-semibold mb-2 block">Namespace</label>
                                <select class="select w-full" id="namespace-selector">
                                    <option selected>Select Namespace</option>
                                    <option value="default">default</option>
                                    <option value="kube-system">kube-system</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button class="btn btn-outline w-full" id="btn-load-secrets">Load Secrets</button>
                            </div>
                        </div>

                        <div class="card">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Namespace</th>
                                        <th># of Keys</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="secrets-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Secret Modal -->
    <div id="create-secret-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold">Create Secret</h2>
                    <button class="btn btn-outline btn-sm" id="modal-close">×</button>
                </div>
            </div>
            
            <div class="modal-body">
                <form id="create-secret-form" class="space-y-6">
                    <div class="form-group">
                        <label class="form-label">Agent</label>
                        <select class="select w-full" id="secret-agent" required>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Namespace</label>
                        <select class="select w-full" id="secret-namespace" required>
                            <option value="default">default</option>
                            <option value="kube-system">kube-system</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Secret Name</label>
                        <input type="text" class="input w-full" id="secret-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Key-Value Pairs</label>
                        <div id="secret-keys" class="space-y-4">
                            <div class="secret-key-row grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" class="input secret-key" placeholder="Key" required>
                                <input type="text" class="input secret-value" placeholder="Value" required>
                                <button type="button" class="btn btn-destructive btn-sm btn-remove-key">Remove</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm mt-4" id="btn-add-key">Add Key</button>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <div class="flex gap-4 justify-end">
                    <button type="button" class="btn btn-secondary" id="modal-cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btn-submit-secret">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Secret Modal -->
    <div id="view-secret-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold" id="view-secret-title">Secret Details</h2>
                    <button class="btn btn-outline btn-sm" id="view-modal-close">×</button>
                </div>
            </div>
            
            <div class="modal-body">
                <div class="space-y-6">
                    <div class="form-group">
                        <label class="form-label">Namespace</label>
                        <input type="text" class="input w-full" id="view-secret-namespace" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="input w-full" id="view-secret-name" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Data</label>
                        <div id="view-secret-data" class="space-y-2">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <div class="flex gap-4 justify-end">
                    <button type="button" class="btn btn-secondary" id="view-modal-cancel">Close</button>
                    <button type="button" class="btn btn-primary" id="btn-edit-secret">Edit</button>
                    <button type="button" class="btn btn-destructive" id="btn-delete-secret">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Franken UI JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.21.13/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.21.13/dist/js/uikit-icons.min.js"></script>

    <script>
        // API base URL
        const API_BASE = '/api/v1';
        
        // DOM Elements
        const agentsList = document.getElementById('agents-list');
        const agentCount = document.getElementById('agent-count');
        const agentsTableBody = document.getElementById('agents-table-body');
        const agentSelector = document.getElementById('agent-selector');
        const secretAgentSelector = document.getElementById('secret-agent');
        
        // Views
        const dashboardView = document.getElementById('dashboard-view');
        const agentsView = document.getElementById('agents-view');
        const secretsView = document.getElementById('secrets-view');
        
        // Modals
        const createSecretModal = document.getElementById('create-secret-modal');
        const viewSecretModal = document.getElementById('view-secret-modal');
        
        // Navigation
        document.getElementById('nav-dashboard').addEventListener('click', showDashboardView);
        document.getElementById('nav-agents').addEventListener('click', showAgentsView);
        document.getElementById('nav-secrets').addEventListener('click', showSecretsView);
        
        // Modal controls
        document.getElementById('modal-close').addEventListener('click', hideCreateSecretModal);
        document.getElementById('modal-cancel').addEventListener('click', hideCreateSecretModal);
        document.getElementById('view-modal-close').addEventListener('click', hideViewSecretModal);
        document.getElementById('view-modal-cancel').addEventListener('click', hideViewSecretModal);
        
        // Click outside modal to close
        createSecretModal.addEventListener('click', (e) => {
            if (e.target === createSecretModal) hideCreateSecretModal();
        });
        viewSecretModal.addEventListener('click', (e) => {
            if (e.target === viewSecretModal) hideViewSecretModal();
        });
        
        // Load initial data
        window.addEventListener('DOMContentLoaded', () => {
            loadAgents();
            setInterval(loadAgents, 5000); // Refresh agents every 5 seconds
        });
        
        // Show different views
        function showDashboardView(e) {
            if (e) e.preventDefault();
            dashboardView.classList.remove('hidden');
            agentsView.classList.add('hidden');
            secretsView.classList.add('hidden');
            
            updateNavigation('nav-dashboard');
        }
        
        function showAgentsView(e) {
            if (e) e.preventDefault();
            dashboardView.classList.add('hidden');
            agentsView.classList.remove('hidden');
            secretsView.classList.add('hidden');
            
            updateNavigation('nav-agents');
        }
        
        function showSecretsView(e) {
            if (e) e.preventDefault();
            dashboardView.classList.add('hidden');
            agentsView.classList.add('hidden');
            secretsView.classList.remove('hidden');
            
            updateNavigation('nav-secrets');
        }
        
        function updateNavigation(activeId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(activeId).parentElement.classList.add('active');
        }
        
        // Load agents
        async function loadAgents() {
            try {
                const response = await fetch(`${API_BASE}/agents`);
                const data = await response.json();
                
                const agents = data.agents || [];
                updateAgentsList(agents);
                updateAgentsTable(agents);
                updateAgentSelectors(agents);
                
                agentCount.textContent = agents.length;
            } catch (error) {
                console.error('Error loading agents:', error);
                document.getElementById('server-status').textContent = 'Offline';
                document.getElementById('server-status').classList.remove('badge-success');
                document.getElementById('server-status').classList.add('badge-destructive');
            }
        }
        
        // Update sidebar agents list
        function updateAgentsList(agents) {
            agentsList.innerHTML = '';
            
            if (agents.length === 0) {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 py-2 px-4 text-sm';
                div.innerHTML = `
                    <span class="agent-status agent-status-offline"></span>
                    No agents connected
                `;
                agentsList.appendChild(div);
                return;
            }
            
            agents.forEach(agent => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 py-2 px-4 text-sm nav-item cursor-pointer';
                div.innerHTML = `
                    <span class="agent-status agent-status-${agent.status.toLowerCase()}"></span>
                    ${agent.name}
                `;
                div.addEventListener('click', () => selectAgent(agent.id));
                agentsList.appendChild(div);
            });
        }
        
        // Update agents table
        function updateAgentsTable(agents) {
            agentsTableBody.innerHTML = '';
            
            agents.forEach(agent => {
                const row = document.createElement('tr');
                const lastSeen = new Date(agent.last_seen);
                
                row.innerHTML = `
                    <td>
                        <div class="flex items-center gap-2">
                            <span class="agent-status agent-status-${agent.status.toLowerCase()}"></span>
                            ${agent.status}
                        </div>
                    </td>
                    <td>${agent.name}</td>
                    <td class="text-sm text-muted-foreground">${agent.id}</td>
                    <td>${agent.metadata.kubernetes_version || 'Unknown'}</td>
                    <td>${agent.metadata.node_count}</td>
                    <td class="text-sm">${lastSeen.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-outline text-sm" onclick="viewAgent('${agent.id}')">Details</button>
                    </td>
                `;
                
                agentsTableBody.appendChild(row);
            });
        }
        
        // Update agent selectors in the UI
        function updateAgentSelectors(agents) {
            // Clear existing options
            agentSelector.innerHTML = '<option selected>Select Agent</option>';
            secretAgentSelector.innerHTML = '';
            
            agents.forEach(agent => {
                if (agent.status.toLowerCase() === 'online') {
                    const option1 = document.createElement('option');
                    option1.value = agent.id;
                    option1.textContent = agent.name;
                    agentSelector.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = agent.id;
                    option2.textContent = agent.name;
                    secretAgentSelector.appendChild(option2);
                }
            });
        }
        
        // Secret management functionality
        let currentSecrets = [];
        let selectedAgent = null;
        let selectedNamespace = 'default';
        
        // Event listeners for secret management
        document.getElementById('btn-create-secret').addEventListener('click', showCreateSecretModal);
        document.getElementById('btn-load-secrets').addEventListener('click', loadSecrets);
        document.getElementById('btn-add-key').addEventListener('click', addSecretKey);
        document.getElementById('btn-submit-secret').addEventListener('click', createSecret);
        document.getElementById('agent-selector').addEventListener('change', onAgentChange);
        document.getElementById('namespace-selector').addEventListener('change', onNamespaceChange);
        
        // Handle dynamic key removal
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-remove-key')) {
                removeSecretKey(e.target);
            }
        });
        
        function onAgentChange(e) {
            selectedAgent = e.target.value;
            if (selectedAgent && selectedAgent !== 'Select Agent') {
                document.getElementById('btn-load-secrets').disabled = false;
            } else {
                document.getElementById('btn-load-secrets').disabled = true;
            }
        }
        
        function onNamespaceChange(e) {
            selectedNamespace = e.target.value;
        }
        
        function showCreateSecretModal() {
            // Reset form
            document.getElementById('create-secret-form').reset();
            
            // Reset secret keys to just one row
            const secretKeys = document.getElementById('secret-keys');
            secretKeys.innerHTML = `
                <div class="secret-key-row grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" class="input secret-key" placeholder="Key" required>
                    <input type="text" class="input secret-value" placeholder="Value" required>
                    <button type="button" class="btn btn-destructive btn-sm btn-remove-key">Remove</button>
                </div>
            `;
            
            createSecretModal.classList.remove('hidden');
        }
        
        function hideCreateSecretModal() {
            createSecretModal.classList.add('hidden');
        }
        
        function hideViewSecretModal() {
            viewSecretModal.classList.add('hidden');
        }
        
        function addSecretKey() {
            const secretKeys = document.getElementById('secret-keys');
            const newRow = document.createElement('div');
            newRow.className = 'secret-key-row grid grid-cols-1 md:grid-cols-3 gap-4';
            newRow.innerHTML = `
                <input type="text" class="input secret-key" placeholder="Key" required>
                <input type="text" class="input secret-value" placeholder="Value" required>
                <button type="button" class="btn btn-destructive btn-sm btn-remove-key">Remove</button>
            `;
            secretKeys.appendChild(newRow);
        }
        
        function removeSecretKey(button) {
            const secretKeys = document.getElementById('secret-keys');
            if (secretKeys.children.length > 1) {
                button.closest('.secret-key-row').remove();
            } else {
                alert('At least one key-value pair is required.');
            }
        }
        
        async function createSecret() {
            const agentId = document.getElementById('secret-agent').value;
            const namespace = document.getElementById('secret-namespace').value;
            const name = document.getElementById('secret-name').value;
            
            if (!agentId || !namespace || !name) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Collect key-value pairs
            const keyInputs = document.querySelectorAll('.secret-key');
            const valueInputs = document.querySelectorAll('.secret-value');
            const data = {};
            
            for (let i = 0; i < keyInputs.length; i++) {
                const key = keyInputs[i].value.trim();
                const value = valueInputs[i].value.trim();
                
                if (!key || !value) {
                    alert('All key-value pairs must be filled.');
                    return;
                }
                
                // Convert string to base64 bytes (Kubernetes secrets store data as base64)
                data[key] = btoa(value);
            }
            
            const secretRequest = {
                operation: 'create',
                namespace: namespace,
                name: name,
                data: data
            };
            
            try {
                const response = await fetch(`${API_BASE}/agents/${agentId}/secrets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(secretRequest)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Secret creation request sent successfully!');
                    
                    // Close modal
                    hideCreateSecretModal();
                    
                    // Refresh secrets if we're viewing the same agent/namespace
                    if (selectedAgent === agentId && selectedNamespace === namespace) {
                        setTimeout(() => loadSecrets(), 1000); // Wait a bit for the operation to complete
                    }
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to create secret'}`);
                }
            } catch (error) {
                console.error('Error creating secret:', error);
                alert('Error creating secret. Please try again.');
            }
        }
        
        async function loadSecrets() {
            if (!selectedAgent || selectedAgent === 'Select Agent') {
                alert('Please select an agent first.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/agents/${selectedAgent}/secrets?namespace=${selectedNamespace}`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Secrets load request sent:', result);
                    
                    // For now, we'll show a message since the actual secrets will come via WebSocket
                    // In a real implementation, you'd want to handle the WebSocket response
                    updateSecretsTable([]);
                    showMessage('Secrets load request sent to agent. Results will appear when received.');
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to load secrets'}`);
                }
            } catch (error) {
                console.error('Error loading secrets:', error);
                alert('Error loading secrets. Please try again.');
            }
        }
        
        function updateSecretsTable(secrets) {
            const tableBody = document.getElementById('secrets-table-body');
            tableBody.innerHTML = '';
            
            if (secrets.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" class="text-center text-muted-foreground">
                        No secrets found or secrets are being loaded...
                    </td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            secrets.forEach(secret => {
                const row = document.createElement('tr');
                const created = secret.metadata && secret.metadata.creationTimestamp
                    ? new Date(secret.metadata.creationTimestamp).toLocaleString()
                    : 'Unknown';
                const keyCount = secret.data ? Object.keys(secret.data).length : 0;
                
                row.innerHTML = `
                    <td>${secret.metadata.name}</td>
                    <td>${secret.metadata.namespace}</td>
                    <td>${keyCount}</td>
                    <td class="text-sm">${created}</td>
                    <td>
                        <div class="flex gap-2">
                            <button class="btn btn-outline text-sm" onclick="viewSecret('${secret.metadata.name}', '${secret.metadata.namespace}')">View</button>
                            <button class="btn btn-outline text-sm" onclick="editSecret('${secret.metadata.name}', '${secret.metadata.namespace}')">Edit</button>
                            <button class="btn btn-destructive text-sm" onclick="deleteSecret('${secret.metadata.name}', '${secret.metadata.namespace}')">Delete</button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        async function viewSecret(name, namespace) {
            if (!selectedAgent) {
                alert('Please select an agent first.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/agents/${selectedAgent}/secrets/${namespace}/${name}`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Secret view request sent:', result);
                    showMessage(`Secret view request sent for ${namespace}/${name}`);
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to view secret'}`);
                }
            } catch (error) {
                console.error('Error viewing secret:', error);
                alert('Error viewing secret. Please try again.');
            }
        }
        
        async function editSecret(name, namespace) {
            // For now, just show an alert. In a full implementation, you'd populate an edit form
            alert(`Edit functionality for secret ${namespace}/${name} would be implemented here.`);
        }
        
        async function deleteSecret(name, namespace) {
            if (!selectedAgent) {
                alert('Please select an agent first.');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete secret ${namespace}/${name}?`)) {
                return;
            }
            
            const secretRequest = {
                operation: 'delete',
                namespace: namespace,
                name: name
            };
            
            try {
                const response = await fetch(`${API_BASE}/agents/${selectedAgent}/secrets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(secretRequest)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Secret deletion request sent successfully!');
                    
                    // Refresh secrets
                    setTimeout(() => loadSecrets(), 1000);
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to delete secret'}`);
                }
            } catch (error) {
                console.error('Error deleting secret:', error);
                alert('Error deleting secret. Please try again.');
            }
        }
        
        // Placeholder for selecting an agent
        function selectAgent(agentId) {
            console.log(`Selected agent: ${agentId}`);
            // Set the agent selector value
            agentSelector.value = agentId;
            selectedAgent = agentId;
            // Show the secrets view
            showSecretsView();
        }
        
        // Placeholder for viewing agent details
        function viewAgent(agentId) {
            console.log(`View agent details: ${agentId}`);
            // This would show a modal with agent details
        }
        
        function showMessage(message) {
            // Create a temporary alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-info';
            alertDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="btn btn-outline text-sm">×</button>
                </div>
            `;
            
            // Insert at the top of the main content
            const mainContent = document.querySelector('.uk-width-4-5\\@m > div');
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
